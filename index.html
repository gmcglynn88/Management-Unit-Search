<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Genesys Cloud Management Unit Lookup</title>
  <style>
    /* Optional basic styling */
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    label, select, button {
      display: block;
      margin: 10px 0;
    }
    #results {
      margin-top: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>

<h1>Genesys Cloud Management Unit Lookup</h1>

<!-- Dropdown to select an agent -->
<label for="agentsSelect">Select an Agent:</label>
<select id="agentsSelect"></select>

<button id="submitBtn">Get Management Unit</button>

<div id="results"></div>

<script>
  /**
   * Replace all occurrences of:
   *   https://api.mypurecloud.com
   * with:
   *   https://api.mypurecloud.ie
   *
   * for the Dublin (Ireland) region.
   */

  // 1) Fetch the list of agents and populate dropdown
  async function getAgents() {
    try {
      const response = await fetch("https://api.mypurecloud.ie/api/v2/users?limit=100", {
        method: "GET",
        headers: {
          "Authorization": "Bearer YOUR_ACCESS_TOKEN",  // Replace with valid token or use Client App SDK
          "Content-Type": "application/json"
        }
      });

      if (!response.ok) {
        throw new Error(`Error fetching users: HTTP ${response.status}`);
      }

      const data = await response.json();

      // data.entities typically contains the list of users in Genesys Cloud
      return data.entities;
    } catch (error) {
      console.error(error);
      alert("Failed to fetch agent list. Check console for more details.");
      return [];
    }
  }

  // 2) Fetch an Agent's Management Unit ID
  async function getAgentManagementUnitId(agentId) {
    try {
      const response = await fetch(`https://api.mypurecloud.ie/api/v2/workforcemanagement/agents/${agentId}/managementunit`, {
        method: "GET",
        headers: {
          "Authorization": "Bearer YOUR_ACCESS_TOKEN",  // Replace with valid token or use Client App SDK
          "Content-Type": "application/json"
        }
      });

      if (!response.ok) {
        // The user might not have an assigned MU, handle the error or check the status
        throw new Error(`Error fetching agent's MU: HTTP ${response.status}`);
      }

      const data = await response.json();
      // data should contain something like { managementUnit: { id: 'xxxxx' } }
      return data.managementUnit && data.managementUnit.id ? data.managementUnit.id : null;
    } catch (error) {
      console.error(error);
      alert("Failed to fetch agent management unit. Check console for more details.");
      return null;
    }
  }

  // 3) Fetch the Management Unit name by ID
  //    Option A: directly call /managementunits/{muId} to fetch a single MU
  //    Option B: fetch all management units, then match the ID
  async function getManagementUnitNameById(managementUnitId) {
    try {
      // Example: fetch one MU by ID instead of listing them all:
      // const response = await fetch(`https://api.mypurecloud.ie/api/v2/workforcemanagement/managementunits/${managementUnitId}`, { ... });
      
      // For demonstration, fetch all MUs to find the name
      const response = await fetch(`https://api.mypurecloud.ie/api/v2/workforcemanagement/managementunits?expand=businessUnit`, {
        method: "GET",
        headers: {
          "Authorization": "Bearer YOUR_ACCESS_TOKEN", // Replace with valid token or use Client App SDK
          "Content-Type": "application/json"
        }
      });

      if (!response.ok) {
        throw new Error(`Error fetching management units: HTTP ${response.status}`);
      }

      const data = await response.json();
      // data.entities should contain an array of management units
      const managementUnits = data.entities || [];
      
      const mu = managementUnits.find(mu => mu.id === managementUnitId);
      return mu ? mu.name : "(Not Found)";
    } catch (error) {
      console.error(error);
      alert("Failed to fetch management unit name. Check console for details.");
      return "(Unknown)";
    }
  }

  // Populate the dropdown on page load
  document.addEventListener("DOMContentLoaded", async () => {
    const agentsSelect = document.getElementById("agentsSelect");
    const submitBtn = document.getElementById("submitBtn");
    const resultsDiv = document.getElementById("results");

    // 1) Get the agents
    const agents = await getAgents();

    // 2) Clear and populate the select dropdown
    agentsSelect.innerHTML = "";
    if (agents && agents.length > 0) {
      agents.forEach(agent => {
        const option = document.createElement("option");
        option.value = agent.id;
        option.text = agent.name || agent.username || "Unknown";
        agentsSelect.appendChild(option);
      });
    } else {
      const option = document.createElement("option");
      option.value = "";
      option.text = "No agents found";
      agentsSelect.appendChild(option);
    }

    // 3) On button click, get the MU for the selected user
    submitBtn.addEventListener("click", async () => {
      resultsDiv.textContent = "Retrieving Management Unit...";
      const selectedAgentId = agentsSelect.value;
      if (!selectedAgentId) {
        alert("No agent selected.");
        return;
      }

      const muId = await getAgentManagementUnitId(selectedAgentId);
      if (!muId) {
        resultsDiv.textContent = "This user might not have an assigned management unit.";
        return;
      }

      const muName = await getManagementUnitNameById(muId);
      resultsDiv.textContent = `Management Unit for selected Agent: ${muName}`;
    });
  });
</script>
</body>
</html>
