<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Genesys Cloud Management Unit Lookup</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    label, select, button {
      display: block;
      margin: 10px 0;
    }
    #results {
      margin-top: 20px;
      font-weight: bold;
    }
  </style>

  <!-- Load the Genesys Cloud JavaScript SDK -->
  <!-- This must load BEFORE you reference `window.platformClient` -->
  <script src="https://sdk-cdn.mypurecloud.com/javascript-platform-client-latest.min.js"></script>
</head>
<body>

<h1>Genesys Cloud Management Unit Lookup</h1>
<div id="loginStatus">Logging in...</div>

<label for="agentsSelect">Select an Agent:</label>
<select id="agentsSelect" disabled></select>

<button id="submitBtn" disabled>Get Management Unit</button>

<div id="results"></div>

<script>
  // Set your Genesys Cloud region (e.g., Ireland)
  const GENESYS_CLOUD_ENV = "mypurecloud.ie";

  // OAuth config from Genesys Cloud Admin > Integrations > OAuth
  const CLIENT_ID = "YOUR_CLIENT_ID";
  const REDIRECT_URI = "YOUR_REDIRECT_URI"; // Must match exactly in OAuth config

  // Access token storage
  let accessToken = null;

  // The Genesys Cloud JS SDK
  const platformClient = window.platformClient;
  const client = platformClient.ApiClient.instance;

  // 1) Initialize Genesys Cloud, do Implicit Grant login
  async function initGenesysCloud() {
    try {
      client.setEnvironment(GENESYS_CLOUD_ENV);

      // If user isn't logged in, they'll be prompted.
      await client.loginImplicitGrant(CLIENT_ID, REDIRECT_URI);

      // Grab the token from the SDK
      accessToken = client.authData.accessToken;
      console.log("Successfully logged in. Token:", accessToken);

      document.getElementById("loginStatus").textContent = "Logged in!";
      document.getElementById("agentsSelect").disabled = false;
      document.getElementById("submitBtn").disabled = false;

      // Now load the Agents list
      loadAgentsIntoDropdown();

    } catch (error) {
      console.error("Error logging in:", error);
      document.getElementById("loginStatus").textContent = "Login failed. Check console.";
    }
  }

  // 2) List agents (up to 100) and populate dropdown
  async function loadAgentsIntoDropdown() {
    const agentsSelect = document.getElementById("agentsSelect");
    agentsSelect.innerHTML = "<option>Loading agents...</option>";

    try {
      const response = await fetch("https://api.mypurecloud.ie/api/v2/users?limit=100", {
        headers: {
          "Authorization": `Bearer ${accessToken}`,
          "Content-Type": "application/json"
        }
      });

      if (!response.ok) {
        throw new Error(`Error listing users: HTTP ${response.status}`);
      }
      const data = await response.json();
      const agents = data.entities || [];

      // Clear the dropdown
      agentsSelect.innerHTML = "";

      if (agents.length > 0) {
        agents.forEach(agent => {
          const opt = document.createElement("option");
          opt.value = agent.id;
          opt.text = agent.name || agent.username || agent.id;
          agentsSelect.appendChild(opt);
        });
      } else {
        const opt = document.createElement("option");
        opt.value = "";
        opt.text = "No agents found";
        agentsSelect.appendChild(opt);
      }
    } catch (err) {
      console.error(err);
      agentsSelect.innerHTML = "<option>Error loading agents</option>";
    }
  }

  // 3) Fetch agent's Management Unit ID
  async function getAgentManagementUnitId(agentId) {
    try {
      const response = await fetch(`https://api.mypurecloud.ie/api/v2/workforcemanagement/agents/${agentId}/managementunit`, {
        headers: {
          "Authorization": `Bearer ${accessToken}`,
          "Content-Type": "application/json"
        }
      });
      if (!response.ok) {
        throw new Error(`Error fetching agent MU: HTTP ${response.status}`);
      }
      const data = await response.json();
      // returns something like: { managementUnit: { id: "..." } }
      return data.managementUnit?.id || null;
    } catch (err) {
      console.error(err);
      return null;
    }
  }

  // 4) Fetch the Management Unit name from ID
  async function getManagementUnitNameById(managementUnitId) {
    try {
      // For demonstration, fetch ALL MUs and find the matching ID
      const response = await fetch("https://api.mypurecloud.ie/api/v2/workforcemanagement/managementunits?expand=businessUnit", {
        headers: {
          "Authorization": `Bearer ${accessToken}`,
          "Content-Type": "application/json"
        }
      });
      if (!response.ok) {
        throw new Error(`Error fetching MUs: HTTP ${response.status}`);
      }
      const data = await response.json();
      const muList = data.entities || [];
      const mu = muList.find(mu => mu.id === managementUnitId);
      return mu ? mu.name : "(Not Found)";
    } catch (err) {
      console.error(err);
      return "(Error)";
    }
  }

  // Handle button click to get MU
  async function onGetManagementUnitClick() {
    const resultsDiv = document.getElementById("results");
    const agentsSelect = document.getElementById("agentsSelect");

    resultsDiv.textContent = "Retrieving Management Unit...";
    const selectedAgentId = agentsSelect.value;
    if (!selectedAgentId) {
      alert("No agent selected.");
      return;
    }

    const muId = await getAgentManagementUnitId(selectedAgentId);
    if (!muId) {
      resultsDiv.textContent = "No assigned Management Unit.";
      return;
    }

    const muName = await getManagementUnitNameById(muId);
    resultsDiv.textContent = `Management Unit for this agent: ${muName}`;
  }

  // Set up
  document.addEventListener("DOMContentLoaded", () => {
    // Kick off the Implicit Grant login
    initGenesysCloud();

    // Wire up the button
    document.getElementById("submitBtn").addEventListener("click", onGetManagementUnitClick);
  });
</script>
</body>
</html>
