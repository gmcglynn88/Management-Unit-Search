<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Genesys Cloud - Management Unit Lookup (Manual Implicit Grant)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    label, select, button {
      display: block;
      margin: 10px 0;
    }
    #results {
      margin-top: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>

<h1>Genesys Cloud Management Unit Lookup</h1>

<label for="agentSelect">Select an Agent:</label>
<select id="agentSelect"></select>

<button id="lookupBtn">Get Management Unit</button>

<div id="results"></div>

<script>
  /**********************************************************
   * 1) CONFIGURE YOUR OAUTH CLIENT INFO + URLS
   **********************************************************/
  const clientId     = "5f8da5c2-f8ef-4168-a321-f06e16f558f3"; // From Genesys Cloud OAuth
  const redirectUri  = "https://gmcglynn88.github.io/Management-Unit-Search/"; // Must match OAuth config exactly
  const responseType = "token";
  const region       = "mypurecloud.ie"; // For Ireland (Dublin)
  const oauthUrl     = `https://login.${region}/oauth/authorize?client_id=${clientId}&response_type=${responseType}&redirect_uri=${encodeURIComponent(redirectUri)}`;

  /**********************************************************
   * 2) ON PAGE LOAD: PARSE TOKEN OR REDIRECT
   **********************************************************/
  document.addEventListener("DOMContentLoaded", () => {
    const token = extractTokenFromUrl();
    if (!token) {
      // If no access_token, redirect to Genesys Cloud login
      window.location.href = oauthUrl;
    } else {
      // We have a token in the URL hash
      initializeApp(token);
    }
  });

  // Extract the #access_token from the URL hash
  function extractTokenFromUrl() {
    // Example URL after login:
    //  https://myapp.com/index.html#access_token=ABC123&token_type=bearer&expires_in=86399&state=...
    const hash = window.location.hash.substring(1);   // remove '#'
    const params = new URLSearchParams(hash);
    return params.get("access_token");
  }

  /**********************************************************
   * 3) INITIALIZE THE APP WITH THE TOKEN
   **********************************************************/
  function initializeApp(token) {
    // Once we have a token, load the list of agents
    loadAgents(token);

    // Wire up the "Get Management Unit" button
    const lookupBtn = document.getElementById("lookupBtn");
    lookupBtn.addEventListener("click", async () => {
      const selectedAgentId = document.getElementById("agentSelect").value;
      if (!selectedAgentId) {
        alert("No agent selected.");
        return;
      }

      const resultsDiv = document.getElementById("results");
      resultsDiv.textContent = "Looking up Management Unit...";

      try {
        const muId = await getAgentManagementUnitId(token, selectedAgentId);
        if (!muId) {
          resultsDiv.textContent = "No Management Unit assigned for this user.";
          return;
        }

        const muName = await getManagementUnitName(token, muId);
        resultsDiv.textContent = `Management Unit: ${muName}`;
      } catch (err) {
        console.error("MU lookup error:", err);
        resultsDiv.textContent = "Error: " + err.message;
      }
    });
  }

  /**********************************************************
   * 4) GET AGENTS
   **********************************************************/
  async function loadAgents(token) {
    const agentSelect = document.getElementById("agentSelect");
    agentSelect.innerHTML = "<option>Loading agents...</option>";

    try {
      // Basic fetch to the Genesys Cloud /users endpoint
      const resp = await fetch(`https://api.${region}/api/v2/users?limit=100`, {
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json"
        }
      });
      if (!resp.ok) {
        throw new Error(`Failed to fetch users: ${resp.status}`);
      }

      const data = await resp.json();
      const users = data.entities || [];
      agentSelect.innerHTML = "";

      if (users.length === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.text = "No agents found.";
        agentSelect.add(opt);
        return;
      }

      for (const user of users) {
        const opt = document.createElement("option");
        opt.value = user.id;
        opt.text = user.name || user.username || user.id;
        agentSelect.add(opt);
      }
    } catch (err) {
      console.error("Error loading agents:", err);
      agentSelect.innerHTML = "<option>Error loading agents</option>";
    }
  }

  /**********************************************************
   * 5) GET A USER'S MANAGEMENT UNIT ID
   **********************************************************/
  async function getAgentManagementUnitId(token, userId) {
    const resp = await fetch(`https://api.${region}/api/v2/workforcemanagement/agents/${userId}/managementunit`, {
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      }
    });
    if (!resp.ok) {
      throw new Error(`MU ID request failed: HTTP ${resp.status}`);
    }
    const data = await resp.json();
    // Typically data: { managementUnit: { id: "12345" } }
    return data.managementUnit?.id || null;
  }

  /**********************************************************
   * 6) GET MANAGEMENT UNIT NAME FROM ID
   **********************************************************/
  async function getManagementUnitName(token, muId) {
    // We'll fetch all MUs, then find the one matching muId
    // For large orgs, you may prefer calling GET /managementunits/{muId} directly
    const resp = await fetch(`https://api.${region}/api/v2/workforcemanagement/managementunits?expand=businessUnit`, {
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      }
    });
    if (!resp.ok) {
      throw new Error(`ManagementUnits request failed: HTTP ${resp.status}`);
    }
    const data = await resp.json();
    const muArray = data.entities || [];
    const mu = muArray.find(item => item.id === muId);
    return mu ? mu.name : "(Not Found)";
  }
</script>

</body>
</html>
